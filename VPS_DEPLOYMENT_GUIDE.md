# ðŸš€ VPS Deployment Guide - PEPSICO CMMS

**Date:** November 29, 2025  
**Version:** 1.0 (Production Ready)  
**Target:** Ubuntu VPS / Cloud Server

---

## ðŸ“‹ Pre-Deployment Checklist

### âœ… What's Ready
- [x] All 167 automated tests passing
- [x] PWA with grid dashboard UI complete
- [x] WhatsApp integration implemented
- [x] 5 utility checklists working (Compressor 1/2, Chiller 1/2, AHU)
- [x] Work Order system complete
- [x] PM Schedule & Execution complete
- [x] Inventory management with auto-sync
- [x] Activity logs & audit trail
- [x] Role-based access control

### âš ï¸ Required Before Deployment
- [ ] VPS server access (SSH credentials)
- [ ] Domain name configured (e.g., cmms.pepsico.com)
- [ ] SSL certificate (Let's Encrypt recommended)
- [ ] Database credentials for production
- [ ] WAHA Cloud deployment for WhatsApp

---

## ðŸ—„ï¸ Database Migration Strategy

### **RECOMMENDED: Fresh Start with Seed Data**

**DO NOT empty the database completely!** You need:

#### Keep These Users (Minimum):
1. **Super Admin** (1 user)
   - GPID: SA001
   - Role: super_admin
   - Email: admin@pepsico.com
   - Department: all

2. **Manager** (1 user per department)
   - Utility Manager
   - Mechanic Manager
   - Electric Manager

3. **Assistant Managers** (if needed)

#### Keep Master Data:
- âœ… **Areas** (Proses, Packaging, Utility)
- âœ… **Sub Areas** (EP, PC, TC, DBM, LBCSS, etc.)
- âœ… **Assets** (All equipment)
- âœ… **Sub Assets** (All equipment components)
- âœ… **Parts** (Spare parts catalog)
- âœ… **Barcode Tokens** (1 per department: all, utility, mechanic, electric)

#### Safe to Delete:
- âŒ Test Work Orders (from development)
- âŒ Test PM Executions
- âŒ Test Checklist Submissions (Compressor, Chiller, AHU)
- âŒ Test Inventory Movements
- âŒ Test Activity Logs
- âŒ Operator test users (OP001, OP002, etc.)

---

## ðŸ”§ VPS Deployment Steps

### Step 1: Server Requirements

**Minimum Specs:**
- **RAM:** 2 GB (4 GB recommended)
- **Storage:** 20 GB SSD
- **OS:** Ubuntu 22.04 LTS
- **PHP:** 8.4
- **Database:** MySQL 8.0 or MariaDB 10.6+
- **Web Server:** Nginx or Apache

**Required PHP Extensions:**
```bash
php8.4-cli
php8.4-fpm
php8.4-mysql
php8.4-xml
php8.4-mbstring
php8.4-curl
php8.4-zip
php8.4-gd
php8.4-bcmath
php8.4-intl
php8.4-redis (optional, for caching)
```

---

### Step 2: Clone Repository to VPS

```bash
# SSH into VPS
ssh user@your-vps-ip

# Navigate to web directory
cd /var/www

# Clone or upload your project
# Option A: Git clone
git clone https://github.com/yourusername/cmmseng.git
# Option B: Upload via SCP/FTP
# scp -r cmmseng/ user@vps-ip:/var/www/

# Set permissions
sudo chown -R www-data:www-data /var/www/cmmseng
sudo chmod -R 755 /var/www/cmmseng
sudo chmod -R 775 /var/www/cmmseng/storage
sudo chmod -R 775 /var/www/cmmseng/bootstrap/cache
```

---

### Step 3: Install Dependencies

```bash
cd /var/www/cmmseng

# Install Composer dependencies (production only, no dev)
composer install --no-dev --optimize-autoloader

# Install NPM dependencies
npm install

# Build assets for production
npm run build
```

---

### Step 4: Configure Environment

```bash
# Copy environment file
cp .env.example .env

# Generate application key
php artisan key:generate

# Edit .env file
nano .env
```

**Production .env Configuration:**

```env
# Application
APP_NAME="PEPSICO CMMS"
APP_ENV=production
APP_KEY=base64:xxx (generated by artisan key:generate)
APP_DEBUG=false
APP_TIMEZONE=Asia/Jakarta
APP_URL=https://cmms.pepsico.com

# Database
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=cmms_production
DB_USERNAME=cmms_user
DB_PASSWORD=your_secure_password_here

# Session & Cache
SESSION_DRIVER=file
SESSION_LIFETIME=120
CACHE_DRIVER=file
QUEUE_CONNECTION=database

# Filament
FILAMENT_PATH=pep
FILAMENT_DOMAIN=null

# WhatsApp WAHA Cloud (Configure after WAHA deployment)
WAHA_API_URL=https://your-waha-instance.sumopod.com
WAHA_API_TOKEN=your-actual-api-token
WAHA_SESSION=default
WAHA_GROUP_ID=120363xxxxxxxxxx@g.us
WAHA_ENABLED=false  # Set to true after testing

# Telescope (Disable in production)
TELESCOPE_ENABLED=false

# Mail (Optional - for notifications)
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@pepsico.com
MAIL_PASSWORD=your-app-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@pepsico.com
MAIL_FROM_NAME="${APP_NAME}"
```

---

### Step 5: Database Setup

**Option A: Fresh Migration with Seeders (RECOMMENDED)**

```bash
# Run migrations
php artisan migrate --force

# Seed master data (Areas, Sub Areas, Assets, Parts, etc.)
php artisan db:seed --class=MasterDataSeeder --force

# Seed users (Super Admin, Managers, etc.)
php artisan db:seed --class=UserSeeder --force

# Seed barcode tokens
php artisan db:seed --class=BarcodeTokenSeeder --force
```

**Option B: Import from Development Database**

```bash
# On local machine: Export clean database
mysqldump -u root cmmseng \
  --ignore-table=cmmseng.work_orders \
  --ignore-table=cmmseng.pm_executions \
  --ignore-table=cmmseng.compressor1_checklists \
  --ignore-table=cmmseng.compressor2_checklists \
  --ignore-table=cmmseng.chiller1_checklists \
  --ignore-table=cmmseng.chiller2_checklists \
  --ignore-table=cmmseng.ahu_checklists \
  --ignore-table=cmmseng.activity_logs \
  > cmms_clean.sql

# Upload to VPS
scp cmms_clean.sql user@vps-ip:/tmp/

# On VPS: Import database
mysql -u cmms_user -p cmms_production < /tmp/cmms_clean.sql

# Clean up
rm /tmp/cmms_clean.sql
```

**After Database Setup:**

```bash
# Create storage link
php artisan storage:link

# Clear all caches
php artisan config:clear
php artisan cache:clear
php artisan route:clear
php artisan view:clear

# Optimize for production
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

---

### Step 6: Web Server Configuration

**Nginx Configuration:**

```nginx
# /etc/nginx/sites-available/cmms.pepsico.com

server {
    listen 80;
    listen [::]:80;
    server_name cmms.pepsico.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name cmms.pepsico.com;
    root /var/www/cmmseng/public;

    # SSL Configuration (Let's Encrypt)
    ssl_certificate /etc/letsencrypt/live/cmms.pepsico.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/cmms.pepsico.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # Security Headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Gzip Compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;

    # Index
    index index.php index.html index.htm;

    # Character Set
    charset utf-8;

    # Logs
    access_log /var/log/nginx/cmms-access.log;
    error_log /var/log/nginx/cmms-error.log;

    # Max Upload Size
    client_max_body_size 20M;

    # Root Location
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP-FPM
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_hide_header X-Powered-By;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
    }

    # Service Worker (must be served from root)
    location = /service-worker.js {
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        try_files $uri =404;
    }

    # PWA Manifest
    location ~ /barcode/manifest/.+\.json$ {
        add_header Cache-Control "no-cache";
        try_files $uri /index.php?$query_string;
    }
}
```

**Enable Site:**

```bash
# Create symlink
sudo ln -s /etc/nginx/sites-available/cmms.pepsico.com /etc/nginx/sites-enabled/

# Test configuration
sudo nginx -t

# Reload Nginx
sudo systemctl reload nginx
```

---

### Step 7: SSL Certificate (Let's Encrypt)

```bash
# Install Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --nginx -d cmms.pepsico.com

# Auto-renewal (should be automatic)
sudo certbot renew --dry-run
```

---

### Step 8: Queue Worker (Optional but Recommended)

```bash
# Create supervisor config
sudo nano /etc/supervisor/conf.d/cmms-worker.conf
```

**Supervisor Configuration:**

```ini
[program:cmms-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/cmmseng/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/var/www/cmmseng/storage/logs/worker.log
stopwaitsecs=3600
```

**Start Queue Worker:**

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start cmms-worker:*
```

---

### Step 9: Cron Jobs (Scheduled Tasks)

```bash
# Edit crontab for www-data user
sudo crontab -u www-data -e
```

**Add this line:**

```cron
* * * * * cd /var/www/cmmseng && php artisan schedule:run >> /dev/null 2>&1
```

---

### Step 10: WAHA Cloud Setup for WhatsApp

**Deploy WAHA on SumoPod:**

1. Go to https://cloud.waha.so
2. Create deployment: WAHA Plus Cloud (512MB) - Rp 35,000/month
3. Wait 5-10 minutes for deployment
4. Copy API URL and API Token
5. Scan QR code to link WhatsApp Business account
6. Create WhatsApp group for notifications
7. Add WAHA number to group
8. Get Group ID from WAHA dashboard

**Update .env on VPS:**

```bash
nano /var/www/cmmseng/.env
```

```env
WAHA_API_URL=https://your-actual-instance.sumopod.com
WAHA_API_TOKEN=your-actual-token-here
WAHA_SESSION=default
WAHA_GROUP_ID=120363xxxxxxxxxx@g.us
WAHA_ENABLED=true
```

**Test WhatsApp:**

```bash
# Clear config cache
php artisan config:clear

# Visit in browser (login as super_admin)
https://cmms.pepsico.com/test-whatsapp
https://cmms.pepsico.com/test-whatsapp-message
```

---

### Step 11: Post-Deployment Verification

**Health Check:**

```bash
# Visit health endpoint
curl https://cmms.pepsico.com/health
```

**Expected Response:**

```json
{
  "status": "healthy",
  "timestamp": "2025-11-29T10:30:00+07:00",
  "database": "connected",
  "cache": "working",
  "app_version": "1.0.0"
}
```

**Test Checklist:**

- [ ] Admin panel accessible: https://cmms.pepsico.com/pep/login
- [ ] Login as super_admin works
- [ ] Dashboard loads without errors
- [ ] PWA form selector accessible via barcode token
- [ ] Submit test Work Order via PWA
- [ ] Submit test Compressor 1 checklist
- [ ] WhatsApp notification received (if enabled)
- [ ] Activity logs recording properly
- [ ] File uploads working (photos in Work Orders)

---

## ðŸ”’ Security Hardening

### 1. File Permissions

```bash
# Laravel recommended permissions
sudo chown -R www-data:www-data /var/www/cmmseng
sudo chmod -R 755 /var/www/cmmseng
sudo chmod -R 775 /var/www/cmmseng/storage
sudo chmod -R 775 /var/www/cmmseng/bootstrap/cache
```

### 2. Hide Sensitive Files

```nginx
# In Nginx config, add to server block:
location ~ /\.env {
    deny all;
}

location ~ /\.git {
    deny all;
}
```

### 3. Database Security

```sql
-- Create dedicated database user with limited privileges
CREATE USER 'cmms_user'@'localhost' IDENTIFIED BY 'secure_password_here';
GRANT SELECT, INSERT, UPDATE, DELETE ON cmms_production.* TO 'cmms_user'@'localhost';
FLUSH PRIVILEGES;
```

### 4. Firewall Configuration

```bash
# UFW (Ubuntu Firewall)
sudo ufw allow 22/tcp   # SSH
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw enable
```

### 5. Fail2Ban (Prevent Brute Force)

```bash
sudo apt install fail2ban

# Create jail for Laravel
sudo nano /etc/fail2ban/jail.d/laravel.conf
```

```ini
[laravel-auth]
enabled = true
port = http,https
filter = laravel-auth
logpath = /var/www/cmmseng/storage/logs/laravel.log
maxretry = 5
bantime = 3600
```

---

## ðŸ“Š Monitoring & Maintenance

### Daily Checks

```bash
# Check disk space
df -h

# Check logs for errors
tail -f /var/www/cmmseng/storage/logs/laravel.log
tail -f /var/log/nginx/cmms-error.log

# Check queue status
php artisan queue:failed
```

### Weekly Tasks

```bash
# Backup database
mysqldump -u cmms_user -p cmms_production > /backups/cmms_$(date +%Y%m%d).sql

# Clean old logs (keep last 30 days)
find /var/www/cmmseng/storage/logs -name "*.log" -mtime +30 -delete

# Update dependencies (test in staging first!)
composer update --no-dev --optimize-autoloader
npm update && npm run build
```

### Monthly Tasks

- Review activity logs for suspicious activity
- Check SSL certificate expiration
- Review and optimize database indexes
- Update system packages: `sudo apt update && sudo apt upgrade`

---

## ðŸ†˜ Troubleshooting

### Issue: 500 Internal Server Error

```bash
# Check logs
tail -f /var/www/cmmseng/storage/logs/laravel.log
tail -f /var/log/nginx/cmms-error.log

# Check permissions
sudo chown -R www-data:www-data /var/www/cmmseng/storage

# Clear caches
php artisan config:clear
php artisan cache:clear
php artisan view:clear
```

### Issue: Database Connection Failed

```bash
# Test MySQL connection
mysql -u cmms_user -p cmms_production

# Check .env database credentials
cat /var/www/cmmseng/.env | grep DB_

# Restart MySQL
sudo systemctl restart mysql
```

### Issue: WhatsApp Notifications Not Sending

```bash
# Test WAHA connection
curl -H "Authorization: Bearer YOUR_TOKEN" https://your-waha-instance.sumopod.com/api/sessions

# Check logs
tail -f /var/www/cmmseng/storage/logs/laravel.log | grep WhatsApp

# Verify .env config
cat /var/www/cmmseng/.env | grep WAHA_
```

### Issue: PWA Not Installing

- Check manifest.json is accessible
- Verify HTTPS is working
- Check service-worker.js is being served
- Clear browser cache and try again

---

## ðŸ“¦ Backup Strategy

### Automated Daily Backups

```bash
# Create backup script
sudo nano /usr/local/bin/cmms-backup.sh
```

**Backup Script:**

```bash
#!/bin/bash

# Configuration
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/cmms"
DB_NAME="cmms_production"
DB_USER="cmms_user"
DB_PASS="your_password"
APP_DIR="/var/www/cmmseng"
RETENTION_DAYS=30

# Create backup directory
mkdir -p $BACKUP_DIR

# Backup database
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/db_$DATE.sql.gz

# Backup uploads (photos, files)
tar -czf $BACKUP_DIR/storage_$DATE.tar.gz $APP_DIR/storage/app/public

# Backup .env file
cp $APP_DIR/.env $BACKUP_DIR/env_$DATE

# Delete old backups
find $BACKUP_DIR -name "*.gz" -mtime +$RETENTION_DAYS -delete
find $BACKUP_DIR -name "env_*" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: $DATE"
```

**Make executable and schedule:**

```bash
sudo chmod +x /usr/local/bin/cmms-backup.sh

# Add to crontab (runs daily at 2 AM)
sudo crontab -e
```

```cron
0 2 * * * /usr/local/bin/cmms-backup.sh >> /var/log/cmms-backup.log 2>&1
```

---

## âœ… Final Checklist Before Go-Live

- [ ] All environment variables configured correctly
- [ ] Database migrated and seeded with production data
- [ ] SSL certificate installed and working
- [ ] WhatsApp WAHA Cloud configured and tested
- [ ] All cron jobs scheduled
- [ ] Queue workers running (if using queues)
- [ ] Backup script configured and tested
- [ ] Firewall configured and enabled
- [ ] Logs are writable and being generated
- [ ] Health check endpoint returns "healthy"
- [ ] Super admin can login successfully
- [ ] PWA accessible via barcode tokens
- [ ] Test submission from mobile device successful
- [ ] WhatsApp notifications working
- [ ] File uploads working (photos)
- [ ] All forms loading without errors

---

## ðŸ“ž Support Resources

- **Laravel Docs:** https://laravel.com/docs/11.x
- **Filament Docs:** https://filamentphp.com/docs/4.x
- **WAHA Cloud:** https://waha.devlike.pro/docs/
- **Let's Encrypt:** https://letsencrypt.org/docs/

---

**Deployment Status:** âœ… Ready for Production  
**Estimated Setup Time:** 2-3 hours  
**Last Updated:** November 29, 2025

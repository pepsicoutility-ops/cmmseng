# ============================================
# CMMS Queue Worker Configuration
# ============================================
# Supervisor configuration for Laravel queue workers
# Place this file in: /etc/supervisor/conf.d/
# ============================================

[program:cmmseng-worker]

# Command to run
command=php /var/www/cmmseng/artisan queue:work database --sleep=3 --tries=3 --max-time=3600 --timeout=300

# Process naming
process_name=%(program_name)s_%(process_num)02d

# Auto start on system boot
autostart=true

# Auto restart if process dies
autorestart=true

# Stop the whole process group
stopasgroup=true

# Kill the whole process group
killasgroup=true

# Run as www-data user
user=www-data

# Number of processes to maintain
numprocs=2

# Redirect stderr to stdout
redirect_stderr=true

# Log file location
stdout_logfile=/var/www/cmmseng/storage/logs/worker.log

# Maximum log file size before rotation
stdout_logfile_maxbytes=10MB

# Number of log file backups
stdout_logfile_backups=5

# Wait time before SIGKILL
stopwaitsecs=3600

# Priority (lower = higher priority)
priority=999

# ============================================
# CONFIGURATION NOTES
# ============================================

# Queue Settings:
# --sleep=3         : Sleep 3 seconds when no jobs available
# --tries=3         : Retry failed jobs 3 times
# --max-time=3600   : Restart worker after 1 hour
# --timeout=300     : Job timeout after 5 minutes

# Process Settings:
# numprocs=2        : Run 2 worker processes (adjust based on load)
#                     For high traffic: 4-8 workers
#                     For low traffic: 1-2 workers

# ============================================
# MANAGEMENT COMMANDS
# ============================================

# After creating this file, run:
# sudo supervisorctl reread
# sudo supervisorctl update
# sudo supervisorctl start cmmseng-worker:*

# Check status:
# sudo supervisorctl status cmmseng-worker:*

# Restart workers:
# sudo supervisorctl restart cmmseng-worker:*

# Stop workers:
# sudo supervisorctl stop cmmseng-worker:*

# View logs:
# sudo supervisorctl tail -f cmmseng-worker:cmmseng-worker_00 stdout
# tail -f /var/www/cmmseng/storage/logs/worker.log

# ============================================
# TROUBLESHOOTING
# ============================================

# If workers won't start:
# 1. Check logs: tail -50 /var/www/cmmseng/storage/logs/worker.log
# 2. Verify PHP path: which php
# 3. Test command manually: php /var/www/cmmseng/artisan queue:work database --once
# 4. Check permissions: ls -la /var/www/cmmseng/storage/logs/

# If jobs aren't processing:
# 1. Check queue table: SELECT * FROM jobs LIMIT 10;
# 2. Check failed jobs: SELECT * FROM failed_jobs;
# 3. Verify .env QUEUE_CONNECTION=database
# 4. Restart workers: supervisorctl restart cmmseng-worker:*

# If memory issues:
# 1. Reduce numprocs (fewer workers)
# 2. Reduce --max-time (more frequent restarts)
# 3. Increase PHP memory_limit in php.ini
# 4. Monitor: top -u www-data
